@using Microsoft.AspNetCore.Identity
@using SkillsHub.Domain.BaseModels;
@using SkillsHub.Domain.Models;
@inject UserManager<ApplicationUser> _userManager;
@inject SkillsHub.Persistence.ApplicationDbContext _context;

@model ApplicationUser;
@{
    var condition = (User.IsInRole("Admin") || User.Identity.Name == Model.Login) && Model != null && Model.UserStudent != null;
}

@if (condition)
{
    var student = Model.UserStudent ?? new SkillsHub.Domain.Models.Student();
    var visitedLessons = Model.UserStudent.VisitedLessons;
    var TotalLessons = Model.UserStudent.Lessons;

<div class="card">
        <div class="card-body">
            <div>
                @{
                    <form style="display:flex; justify-content:space-between">
                        <input type="hidden" asp-for="@student.Id" value="@student.Id" />
                        <input type="hidden" asp-for="@student.ApplicationUserId" value="@Model.Id" />
                        @if (!(await _userManager.IsInRoleAsync(Model, "Student")) || Model.UserStudent.IsDeleted)
                        {

                            <h3 style="color:dimgray">Статистика ученика - UnActive</h3>
                        }
                        else
                        {
                            <h3>Статистика ученика - Active</h3>
                        }
                        @if (student.Id == Guid.Empty)
                        {
                            student.Id = Model.Id;
                        }
                        @if(User.IsInRole("Admin"))
                        {
                            <input class="btn btn-primary btn-sm" type="submit" value="↑↓" asp-route-id="@student.Id" asp-action="Activate" asp-route-userId="@Model.Id" asp-controller="Student" />

                        }

                    </form>

                }

            </div>
            <div style="display:flex; justify-content:space-between">
                <b>Working schedule: </b>
                @if (student.WorkingDays != null)
                {
                    <ol style="padding-left:0.2%">

                        @foreach (var item in student.WorkingDays.Split("-"))
                        {
                            <li>@item.ToString()</li>
                        }
                    </ol>
                }
                <b></b>
                <b></b>



            </div>

            
            <div style="display:flex; justify-content:space-between">

                <b>Направления работы:</b> @{
                    if (student.PossibleCources != null)
                    {

                        <ol>
                            @foreach (var item in student.PossibleCources.Select(x => x.LessonType.Name))
                            {
                                <li>@item</li>
                            }
                        </ol>
                    }
                    else
                    {
                        <p>EMPTY</p>
                    }
                }
                <b></b>
                <hr />
                <!------------------------CHANGEEEEE------------------------------->

            </div>


            
            <hr/>
            <div>
                @{
                    var visitedLessonsCount = _context.LessonStudents.Where(x => x.StudentId == Model.UserStudent.Id).Select(x => x.Lesson).Where(x => x.IsСompleted).Count();
                    var missedLessonsCount = _context.LessonStudents.Where(x => x.StudentId == Model.UserStudent.Id && (x.VisitStatus==2 || x.VisitStatus ==3)).Select(x => x.Lesson).Where(x => x.IsСompleted).Count();
                    var missedLessonsCountWithoutWriteOff = _context.LessonStudents.Where(x => x.StudentId == Model.UserStudent.Id && (x.VisitStatus == 3)).Select(x => x.Lesson).Where(x => x.IsСompleted).Count();

                    var arrivedLessonsCount = _context.LessonStudents.Where(x => x.StudentId == Model.UserStudent.Id).Select(x => x.Lesson).Count();
                }
                Lessons: visited @visitedLessonsCount @if (@missedLessonsCount != 0) {<span>(missed @missedLessonsCount, without write - off @missedLessonsCountWithoutWriteOff)</span>} из @arrivedLessonsCount<br /> Payable now / for full courses: @Model.UserStudent.CurrentCalculatedPrice BYN / @Model.UserStudent.TotalCalculatedPrice BYN
            </div>
            <div>
                Paid: --- BYN
            </div>
            <!--
            <div>
                Посещено групп англ / индив англ / групп прогр:
            </div>
            -->
            <!--
            <div>
                Ожидаемые групповых английский / индивидуальных английский / групповых программирование:
            </div>
            -->
            <!--
            <div>
                Оплачено групповых английский / индивидуальных английский / групповых программирование:
            </div>
            -->

        </div>
    </div>


}
