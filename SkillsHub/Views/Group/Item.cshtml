@using SkillsHub.Application.DTO;
@inject SkillsHub.Persistence.ApplicationDbContext _context;

@model Group

@if (Model != null)
{
    Group Group = Model;

    <div class="row page-titles mx-0">
        <div class="col p-md-0">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">Dashboard</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">Home</a></li>
            </ol>
        </div>
    </div>
    <!-- row -->

    <form class="form-valide" action="#" method="post">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <div class="card">
                        <div class="card-body">

                           
                            <div style="display:flex;justify-content:space-between">
                                <h2 style="margin-bottom:5%">Group </h2>
                                @if(User.IsInRole("Admin"))
                                {
                                    <input type="submit" asp-action="Delete" asp-controller="Group" value="X" class="btn btn-outline-danger" asp-route-id="@Model.Id" />
                                }      
                            </div>

                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    Name <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <p class=" col-form-label">@Model.Name</p>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    CourseName <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <p class="col-form-label">@Model.CourseName.Name</p>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    Teacher <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <a asp-action="Item" asp-controller="Account" asp-route-itemid="@Group.Teacher.ApplicationUser.Id" class="col-form-label" style="font-weight:900;color:#7571f9">
                                        @Group.Teacher.ApplicationUser.FirstName  @Group.Teacher.ApplicationUser.Surname @Group.Teacher.ApplicationUser.LastName
                                    </a>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    Lesson type <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <p class="col-form-label">@Group.LessonType.Name</p>
                                </div>
                            </div>
                            <!--
                            <div class="form-group row">
                            <label class="col-lg-4 col-form-label">
                            Term <span class="text-danger">*</span>
                            </label>
                            <div class="col-lg-6">
                            <p class="col-form-label">Group.Term</p>
                            </div>
                            </div>
                            -->
                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    Date start <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <p class="col-form-label">@Group.DateStart.ToLongDateString()</p>
                                </div>
                            </div>
                            

                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    Lessons count <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <p class="col-form-label">@Group.Lessons.Count</p>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-lg-4 col-form-label">
                                    Students in group <span class="text-danger">*</span>
                                </label>
                                <div class="col-lg-6">
                                    <ol>
                                        @foreach (var st in Group.GroupStudents.Select(x => x.Student))
                                        {
                                            <li><a asp-action="Item" asp-controller="Account" asp-route-itemId="@st.Id" style="font-weight:900;color:#7571f9">
                                                    @st.ApplicationUser.FirstName @st.ApplicationUser.Surname @st.ApplicationUser.LastName
                                                </a></li>
                                        }

                                    </ol>

                                </div>
                            </div>



                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                           
                                <h4>SHEDULE</h4>
                            
                            
                            <div class="col">
                                @foreach (var ds in Group.DaySchedules)
                                {

                                    <div class="card">
                                        <div class="card-body">
                                            <div>@ds.DayName: @ds.WorkingStartTime-@ds.WorkingEndTime</div>
                                        </div>
                                    </div>

                                }
                                @if (User.IsInRole("Admin"))
                                {
                                    <form>
                                        <!--<input type="hidden" asp-for="Model.Id" value="Model.Id"/>-->

                                        <input type="submit" value="Edit group" asp-action="Edit" asp-controller="Group" formmethod="get" asp-route-id="@Model.Id" class="btn btn-primary" />
                                    </form>
                                }

                            </div>
                        </div>
                    </div>

                    @if (User.IsInRole("Admin"))
                    {
                        <div class="card">
                            <div class="card-body">
                                <h4>Bills</h4>
                                <div class="col">

                                    <div class="form-group" style="display:flex">
                                        <span>Current Teacher salary : ?  |  </span>
                                        <span>Full Teacher salary : ?</span>
                                    </div>

                                    <div class="form-group">
                                        <span>Current Students money : ?  |  </span>
                                        <span>Full Students money : ?</span>
                                    </div>

                                    <div class="form-group">
                                        <span>Current difference : ?  |  </span>
                                        <span>Full difference : ?</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                </div>




                <div class="row">
                    <div style="display:flex; justify-content:space-between">
                        <h4>LESSONS</h4>
                        <div style="display:flex;"/>


                        @if (User.IsInRole("Admin"))
                        {
                            <input type="submit" asp-action="Create" asp-controller="Lessons" asp-route-itemid="@Model.Id" value="+" class="btn btn-primary" />
                        }
                    </div>
                </div>
                @{
                    var lessons = _context.Lessons.Where(x => x.GroupId == Model.Id).ToList();
                }
                <span>Assigned @lessons.Count() out of @Model.LessonsCount; Passed @lessons.Where(x => x.EndTime.Ticks < @DateTime.Now.Ticks).Count() </span>

                <!--NAVBAR - Search, Filter, Sort-->
                <nav class="navbar navbar-expand-lg bg-light">
                    <div class="container-fluid">

                        <div class="collapse navbar-collapse" id="navbarSupportedContent" style="display:flex;grid-gap:20px">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                <li class="nav-item">
                                    <div class="input-group icons">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-transparent border-0 pr-2 pr-sm-3" id="basic-addon1"><i class="mdi mdi-magnify"></i></span>
                                        </div>
                                        <input type="search" onchange="changeCourseName() id="searchByTopic" class="form-control" placeholder="Search by topic" aria-label="Search by topic">
                                        <div class="drop-down   d-md-none">

                                        </div>
                                    </div>
                                </li>


                                

                                <li class="nav-item" style="display:flex;align-items:baseline;grid-gap:10px">
                                    <p>Teacher:</p>

                                    <select class="form-control" id="searchByTeacher" name="val-skill" onchange="changeCourseName()">
                                        <option value="" selected>Все</option>
                                        @if (ViewBag.Teachers != null)
                                        {
                                            @foreach (Teacher item in ViewBag.Teachers)
                                            {
                                                <option value="@item.Id">@item.ApplicationUser.FirstName @item.ApplicationUser.LastName @item.ApplicationUser.Surname</option>
                                            }
                                        }

                                    </select>
                                </li>

                                <!--
                                <li class="nav-item" style="display:flex;align-items:baseline;grid-gap:10px">
                                    <p>Category:</p>

                                    <select class="form-control" id="searchByCategory" name="val-skill" onchange="changeCourseName()">
                                        <option value="" selected>All</option>
                                        <option value="" selected>Сanceled</option>
                                        <option value="" selected>Transferred</option>
                                    </select>
                                </li>
                                -->

                                <li class="nav-item" style="display:flex;align-items:baseline;grid-gap:10px">
                                    <p>Student:</p>

                                    <select class="form-control" id="searchStudent" name="val-skill" onchange="changeCourseName()">
                                        <option value="" selected>Все</option>
                                        @if (ViewBag.Students != null)
                                        {
                                            @foreach (Student item in ViewBag.Students)
                                            {
                                                <option value="@item.Id">@item.ApplicationUser.FirstName @item.ApplicationUser.LastName @item.ApplicationUser.Surname</option>
                                            }
                                        }

                                    </select>
                                </li>

                                <li class="nav-item" style="display:flex;align-items:baseline;grid-gap:10px">
                                    <p>Category:</p>

                                    <select class="form-control" id="searchByCategory" name="val-skill" onchange="changeCourseName()">
                                        <option value="" selected>All</option>
                                        <option value="" selected>Passed</option>
                                        <option value="" selected>Сurrent</option>
                                    </select>
                                </li>

                                <!--
                                <li class="nav-item" style="display:flex;align-items:baseline;grid-gap:10px">
                                    <p style="white-space:nowrap">Date:</p>
                                    <input type="datetime" id="searchMinDate" />
                                    <input type="date" id="searchMaxDate" />
                                </li>
                                -->


                                <li class="nav-item" style="display:flex;align-items:baseline;grid-gap:10px">
                                    <p style="white-space:nowrap">Сортировать по:</p>
                                    <select class="form-control" id="val-skill" name="val-skill">
                                        <option value="orderDateAsc" selected>Времени создания (↑)</option>
                                        <option value="" selected>Времени создания (↓)</option>
                                        <option value="" selected>Количеству учеников</option>

                                    </select>
                                </li>
                                <li class="nav-item">
                                    <input type="button" onclick="Reset()" class="btn btn-primary" style="margin-left:5px; height:100% " value="Reset" />
                                    <input type="button" onclick="GetLessonsByGroup()" class="btn btn-primary" style="margin-left:5px; height:100% " value="Search" />
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>



                <div id="lessonsList">
                    <!--await Html.PartialAsync("_LessonsList")-->
                </div>



            </div>
        </div>
    </form>


    <script src="~/plugins/common/common.min.js"></script>
	<script src="~/js/custom.min.js"></script>
	<script src="~/js/settings.js"></script>
	<script src="~/js/gleek.js"></script>
	<script src="~/js/styleSwitcher.js"></script>

	


    <script>



        function GetLessonsByGroup() {

            
        var filters = {}
        var orders = {}

        try {
        const searchLessonByTopic = document.getElementById("searchLessonByTopic").value;


        //const searchLessonByTopic = document.getElementById("courcesNames").value;

        filters = {
        Topic: searchLessonByTopic,
        Teacher : searchByTeacher,
        Student : searchByStudent,
        Group: searchByGroup,

        //ParentName: parentName,
        //PossibleCourse: category,
        //MinDateCreated: minDate,
        //GroupId = groupId
        };




        const order = document.getElementById("courcesNames").value;

        orders = {
            OrderColumn: "DateCreated",
            OrderType : "asc"
        }

        // Perform further actions with the selected values, such as filtering or sending a request
        console.log(filters);
        }
        catch (ex) { console.log("err"); }


        var data = {
        StudentFilterModel: filters,
        StudentOrderModel: orders
        };

        //------------------------------------------------------------------

            console.log("ol");

        //var list = document.getElementById("allLessons");
        //var count = document.getElementsByClassName("lessonInGroup").count; //id of new element;
            $("#lessonsList").load("/Lesson/GetByGroup", { id : '@Model.Id', filters  : filters, order : orders });

           


            console.log("ol2");
        /*
        $.ajax({
        url: "/Lesson/GetByGroup?id=" + Model.Id,
        type: "GET",
        data: data,

        success: function (data) {
        // Обновление части страницы с полученным частичным представлением
        $('#AdminLink').empty();
        $('#AdminLink').html(data);
        },
        error: function (xhr, status, error) {
        // Обработка ошибки
        console.error(error);
        }
        });

        */

        }


        $(document).ready(function () {

            GetLessonsByGroup();
        });


        

        function CreateNewLesson() { 
        var list = document.getElementById("allLessons");
        var count = document.getElementsByClassName("lessonInGroup").count; //id of new element;


        var appendLine = "<div class='col lessonInGroup"+ count + "+'><form method = 'post' ><div class='card' style = 'margin:1%' ><div class='card-body'>"
        appendLine+= "<div style='display:flex; justify-content:space-between'>"
        appendLine += "<div>" + count + ".  New not saved item  </div>"
        appendLine += "<input type='button' onclick='DeleteNewLesson(" + count + ")' value='X' class='btn btn-danger' />"
        appendLine += "</div>"
        appendLine += "<div style='display:flex; justify-content:space-between'><div style='display:flex; grid-gap:5%'>"
        appendLine += "<input type='time' name = 'startTime' asp-for='item.StartTime' /> -"
        appendLine += "<input type='time' name = 'endTime' asp-for='item.EndTime' />"
        appendLine += "</div>"
        appendLine += "<input type = 'submit' asp-action='Create' asp-controller='Lessons'  value = 'Save' class='btn btn - primary' />"
        appendLine += "</div>"

        appendLine += "</div></div></form></div>"
        list.appendChild(appendLine);

        }

        function DeleteNewLesson(count) {
        var elem = document.getElementsByClassName("lessonInGroup" + count);
        elem.outerHTML = "";

        }

        function RequestToChangeLesson(itemId) {
        //Serialize the form datas.

        var valdata = $("#lesson" + itemId).serialize();
        var data = JSON.stringify($("#lesson" + itemId).serializeArray()); //  <-----------

        console.log(valdata)

        console.log("----")
        console.log(data);

        //to get alert popup
        $.ajax({
        url: "/Request/Edit",
        type: "POST",
        dataType: 'json',
        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
        data: valdata

        });
        alert("Request was send");

        //$("<div>Saved</div>").insertAfter($("#lessonTypeForm"));

        }


    </script>

    <!-- #/ container -->
}